# auth-service v0.2.8 环境配置示例

# === 基本配置 ===
NODE_ENV=development
PORT=8080
ISSUER_URL=http://localhost:8080

# === 数据库连接 ===
DATABASE_URL=postgresql://user:password@localhost:5432/auth_service_dev

# === 令牌有效期 ===
# Access Token 有效期（秒）
ACCESS_TOKEN_TTL_SECONDS=1800
# Refresh Token 有效期（秒，30天）
REFRESH_TOKEN_TTL_SECONDS=2592000

# === 多租户配置 ===
DEFAULT_TENANT_ID=tenant-dev
DEFAULT_AUD_PREFIX=tymoe-service
TENANT_ENFORCE_AUD=true

# === 内省客户端配置（网关使用） ===
INTROSPECT_CLIENT_ID=gateway
INTROSPECT_CLIENT_SECRET=gateway-secret

# === JWKS 缓存 ===
JWKS_MAX_AGE_SEC=3600

# === 身份管理 ===
PASSWORD_HASH_ROUNDS=10
SESSION_SECRET=your-session-secret-key-min-32-chars

# === 邮件发送配置 ===
# 开发环境使用 CONSOLE，生产环境使用 SMTP
MAIL_TRANSPORT=CONSOLE
# 生产环境 SMTP 服务器配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=noreply@yourdomain.com
SMTP_PASS=your-smtp-password
SMTP_AUTH_USER=noreply@yourdomain.com
SMTP_AUTH_PASS=your-smtp-password
MAIL_FROM="Your Service <no-reply@yourdomain.com>"
MAIL_REPLY_TO="support@yourdomain.com"

# === Redis 配置（缓存和限流） ===
REDIS_URL=redis://127.0.0.1:6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_NAMESPACE=authsvc
REDIS_CONNECT_TIMEOUT=5000
REDIS_COMMAND_TIMEOUT=3000
REDIS_MAX_RETRIES=3

# === v0.2.8 设备证明配置 ===
# 需要设备证明的产品（逗号分隔）- 仅 mopai 强制，ploml 可选
REQUIRE_DEVICE_PROOF_FOR=mopai
# host 类型设备的证明模式：device_secret 或 dpop
PROOF_MODE_HOST=device_secret
# kiosk 类型设备的证明模式：device_secret 或 dpop
PROOF_MODE_KIOSK=device_secret
# 设备密钥长度（字节）
DEVICE_SECRET_LENGTH=32
# 设备 JWT 有效期（秒，5分钟）
DEVICE_JWT_TTL_SEC=300
# 设备 JWT 签名算法
DEVICE_JWT_ALGORITHM=HS256

# === v0.2.8 产品特定刷新策略 ===
# mopai 产品的刷新策略：sliding_renewal 或 rotation_threshold
REFRESH_STRATEGY_MOPAI=sliding_renewal
# ploml 产品的刷新策略：sliding_renewal 或 rotation_threshold  
REFRESH_STRATEGY_PLOML=rotation_threshold

# Mopai（设备）刷新策略数值
REFRESH_MOPAI_SLIDING_EXTEND_SEC=2592000        # 30天
REFRESH_MOPAI_ROTATION_THRESHOLD_SEC=1296000    # 360小时
REFRESH_MOPAI_MAX_LIFETIME_SEC=0                # 0=无限
REFRESH_MOPAI_INACTIVITY_TIMEOUT_SEC=2592000    # 30天不活跃超时

# Ploml（人账号）刷新策略数值
REFRESH_PLOML_SLIDING_EXTEND_SEC=1296000        # 15天
REFRESH_PLOML_ROTATION_THRESHOLD_SEC=648000     # 180小时
REFRESH_PLOML_MAX_LIFETIME_SEC=31536000         # 365天

# === v0.2.8 JTI 缓存和限流 ===
# 启用 JTI 缓存的产品（逗号分隔）
JTI_CACHE_ENABLED_PRODUCTS=mopai,ploml
# JTI 缓存有效期（秒）
JTI_CACHE_TTL_SEC=3600
# 设备证明限流（每小时最大请求数）
DEVICE_PROOF_RATE_LIMIT=100
# 设备证明限流时间窗口（秒）
DEVICE_PROOF_RATE_WINDOW_SEC=3600

# === 验证码复用/有效期（分钟） ===
# 验证码有效时间（分钟）
VERIFY_CODE_TTL_MIN=10
# 验证码复用窗口（分钟），此时间内重发同一验证码
VERIFY_REUSE_WINDOW_MIN=10
# 重置密码验证码有效时间（分钟）
RESET_CODE_TTL_MIN=10
# 重置密码验证码复用窗口（分钟）
RESET_REUSE_WINDOW_MIN=10

# === 限流阈值（每小时上限），邮箱与IP都应用 ===
# 每小时最大注册次数
RATE_MAX_REGISTER_PER_HR=10
# 每小时最大验证次数
RATE_MAX_VERIFY_PER_HR=10
# 每小时最大重置密码次数
RATE_MAX_RESET_PER_HR=10
# 每小时最大登录次数
RATE_MAX_LOGIN_PER_HR=10

# === 登录失败阈值 ===
# 登录失败多少次后要求验证码
LOGIN_CAPTCHA_THRESHOLD=3
# 登录失败多少次后锁定账户
LOGIN_LOCK_THRESHOLD=10
# 账户锁定时间（分钟）
LOGIN_LOCK_MINUTES=30

# === reCAPTCHA 配置（可选） ===
# 是否启用 CAPTCHA 验证
CAPTCHA_ENABLED=false
# Google reCAPTCHA 站点密钥（前端用）
CAPTCHA_SITE_KEY=your-recaptcha-site-key
# Google reCAPTCHA 私钥（后端用）
CAPTCHA_SECRET_KEY=your-recaptcha-secret-key
# reCAPTCHA 验证 URL
CAPTCHA_VERIFY_URL=https://www.google.com/recaptcha/api/siteverify

# === 审计和安全 ===
AUDIT_TO_FILE=true
AUDIT_FILE_PATH=./logs/audit.log
ENHANCED_AUDIT_LOGGING=true

# === 受众验证 ===
ALLOWED_AUDIENCES=tymoe-service

# === v0.2.8 订阅配额控制（临时本地硬限制） ===
SUBS_ENABLE_LOCAL_QUOTA_ENFORCE=true

# ploml 员工配额：Trial 3、Basic 3、Standard 5、Pro 10、Professor 18
QUOTA_PLOML_STAFF_TRIAL=3
QUOTA_PLOML_STAFF_BASIC=3
QUOTA_PLOML_STAFF_STANDARD=5
QUOTA_PLOML_STAFF_PRO=10
QUOTA_PLOML_STAFF_PROFESSOR=18

# mopai 设备配额：Basic 0、Standard 1、Pro 3、Professor 5
QUOTA_MOPAI_DEVICE_BASIC=0
QUOTA_MOPAI_DEVICE_STANDARD=1
QUOTA_MOPAI_DEVICE_PRO=3
QUOTA_MOPAI_DEVICE_PROFESSOR=5

# === v0.2.7 验证码加密（用于复用窗口） ===
# 32字节 AES-256-GCM 对称密钥（base64），仅用于验证码复用窗口内的"重发同一验证码"
# 生产环境必须配置；如不配置，则复用窗口内只提示"已发送"，不重发同码
# 生成方式： openssl rand -base64 32
VERIFICATION_CODE_ENC_KEY=base64:your-32-byte-key-in-base64

# === v0.2.8-p1 产品识别和计划管理 ===
# Unknown 产品类型的默认策略: ploml | mopai | reject
UNKNOWN_PRODUCT_STRATEGY=ploml
# 客户端产品类型映射: clientId:productType,clientId:productType  
PRODUCT_CLIENT_MAP=web-mopai:mopai,kiosk-mopai:mopai,web-ploml:ploml,mobile-ploml:ploml
# 默认订阅计划
DEFAULT_PLAN_MOPAI=standard
DEFAULT_PLAN_PLOML=basic

# === 订阅服务接入（预留） ===
# 订阅服务 URL（为空则使用本地配额控制）
SUBS_SERVICE_URL=
# 订阅服务认证 token
SUBS_SERVICE_TOKEN=

# === 兼容性保留（向后兼容旧版本配置） ===
SIGNUP_CODE_TTL_SEC=600
RESET_CODE_TTL_SEC=600
CODE_ATTEMPT_MAX=5
VERIFICATION_CODE_REUSE_WINDOW_SEC=600
RATE_WINDOW_SEC=60
RATE_MAX_LOGIN=5
RATE_MAX_REGISTER=5
RATE_MAX_RESET=5
RATE_LOGIN_EMAIL_MAX=10
RATE_LOGIN_EMAIL_WINDOW_SEC=3600
RATE_LOGIN_IP_MAX=50
RATE_LOGIN_IP_WINDOW_SEC=3600
LOGIN_MAX_FAILURES=10
LOGIN_LOCKOUT_DURATION_SEC=1800